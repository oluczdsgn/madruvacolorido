import React, { useState, useEffect, useRef } from 'react';

// --- Funções Utilitárias de Cor (fora do componente para não serem recriadas) ---
function hexToRgb(hex) {
    hex = hex.replace(/^#/, '');
    const r = parseInt(hex.substring(0, 2), 16);
    const g = parseInt(hex.substring(2, 4), 16);
    const b = parseInt(hex.substring(4, 6), 16);
    return { r, g, b };
}

function rgbToCmyk(r, g, b) {
    if (r === 0 && g === 0 && b === 0) return { c: 0, m: 0, y: 0, k: 100 };
    let c = 1 - (r / 255);
    let m = 1 - (g / 255);
    let y = 1 - (b / 255);
    let k = Math.min(c, m, y);
    c = (c - k) / (1 - k);
    m = (m - k) / (1 - k);
    y = (y - k) / (1 - k);
    return {
        c: Math.round(c * 100),
        m: Math.round(m * 100),
        y: Math.round(y * 100),
        k: Math.round(k * 100)
    };
}

function hexToHsl(hex) {
    const { r, g, b } = hexToRgb(hex);
    const r_norm = r / 255, g_norm = g / 255, b_norm = b / 255;
    const max = Math.max(r_norm, g_norm, b_norm), min = Math.min(r_norm, g_norm, b_norm);
    let h, s, l = (max + min) / 2;
    if (max === min) { h = s = 0; } 
    else {
        const d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
        switch (max) {
            case r_norm: h = (g_norm - b_norm) / d + (g_norm < b_norm ? 6 : 0); break;
            case g_norm: h = (b_norm - r_norm) / d + 2; break;
            case b_norm: h = (r_norm - g_norm) / d + 4; break;
        }
        h /= 6;
    }
    return [h * 360, s, l];
}

function hslToHex(h, s, l) {
    let r, g, b;
    if (s === 0) { r = g = b = l; } 
    else {
        const hue2rgb = (p, q, t) => {
            if (t < 0) t += 1;
            if (t > 1) t -= 1;
            if (t < 1 / 6) return p + (q - p) * 6 * t;
            if (t < 1 / 2) return q;
            if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
            return p;
        };
        const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
        const p = 2 * l - q;
        r = hue2rgb(p, q, h / 360 + 1 / 3);
        g = hue2rgb(p, q, h / 360);
        b = hue2rgb(p, q, h / 360 - 1 / 3);
    }
    const toHex = x => Math.round(x * 255).toString(16).padStart(2, '0');
    return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
}

// --- Componente ColorBox ---
const ColorBox = ({ hex, onCopy }) => {
    const { r, g, b } = hexToRgb(hex);
    const { c, m, y, k } = rgbToCmyk(r, g, b);

    return (
        <div className="flex flex-col items-center group cursor-pointer" onClick={() => onCopy(hex)}>
            <div className="glass-border p-2 rounded-xl transform group-hover:scale-110 transition-transform duration-200">
                <div className="w-20 h-20 md:w-24 md:h-24 rounded-lg shadow-lg" style={{ backgroundColor: hex }}></div>
            </div>
            <p className="mt-4 font-mono text-muted-theme group-hover:text-theme transition-colors text-sm">{hex.toUpperCase()}</p>
            <p className="font-mono text-muted-theme/70 group-hover:text-theme/80 transition-colors text-xs">{`C:${c} M:${m} Y:${y} K:${k}`}</p>
        </div>
    );
};

// --- Componente HomePage ---
const HomePage = ({ onCopy }) => {
    const wheelCanvasRef = useRef(null);
    const [currentHex, setCurrentHex] = useState('#6366f1');
    const [indicatorPos, setIndicatorPos] = useState({ x: 0, y: 0 });
    const [indicatorColor, setIndicatorColor] = useState('white');

    useEffect(() => {
        const canvas = wheelCanvasRef.current;
        const ctx = canvas.getContext('2d');
        const size = 250;
        const radius = size / 2;

        function drawColorWheel() {
            for (let angle = 0; angle < 360; angle++) {
                for (let r = 0; r < radius; r++) {
                    const hue = angle;
                    const saturation = r / radius;
                    const lightness = 0.5;
                    ctx.fillStyle = `hsl(${hue}, ${saturation * 100}%, ${lightness * 100}%)`;
                    const startAngle = (angle - 1) * Math.PI / 180;
                    const endAngle = angle * Math.PI / 180;
                    ctx.beginPath();
                    ctx.moveTo(radius, radius);
                    ctx.arc(radius, radius, r, startAngle, endAngle);
                    ctx.closePath();
                    ctx.fill();
                }
            }
        }
        
        drawColorWheel();

        const [h, s] = hexToHsl(currentHex);
        const initialRadius = s * radius;
        const initialAngle = h * Math.PI / 180;
        setIndicatorPos({
            x: radius + initialRadius * Math.cos(initialAngle),
            y: radius + initialRadius * Math.sin(initialAngle)
        });

    }, []);
    
    const handleWheelClick = (e) => {
        const canvas = wheelCanvasRef.current;
        const ctx = canvas.getContext('2d');
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const imageData = ctx.getImageData(x, y, 1, 1).data;
        const r = imageData[0].toString(16).padStart(2, '0');
        const g = imageData[1].toString(16).padStart(2, '0');
        const b = imageData[2].toString(16).padStart(2, '0');
        
        setCurrentHex(`#${r}${g}${b}`);
        setIndicatorPos({ x, y });
        setIndicatorColor((imageData[0] + imageData[1] + imageData[2] > 382) ? 'black' : 'white');
    };

    const [h, s, l] = hexToHsl(currentHex);
    const complementaryPalette = [30, 150, 210, 120, 240].map(offset => {
        const newHue = (h + offset) % 360;
        const newSat = Math.max(0.4, s);
        const newLight = Math.max(0.3, Math.min(0.8, l));
        return hslToHex(newHue, newSat, newLight);
    });

    const pastelPalette = [{ s: 0.55, l: 0.88 }, { s: 0.65, l: 0.82 }, { s: 0.45, l: 0.92 }, { s: 0.75, l: 0.85 }].map(variation => {
        return hslToHex(h, variation.s, variation.l);
    });

    return (
        <div className="container mx-auto p-8 text-center">
            <h1 className="text-4xl font-bold mb-4">Gerador de Paleta de Cores</h1>
            <p className="text-muted-theme mb-8">Clique no círculo cromático para selecionar uma cor base.</p>

            <div className="flex justify-center mb-12 w-[250px] h-[250px] mx-auto relative cursor-crosshair" onClick={handleWheelClick}>
                <canvas ref={wheelCanvasRef} width="250" height="250"></canvas>
                <div className="absolute w-5 h-5 border-4 rounded-full pointer-events-none transform -translate-x-1/2 -translate-y-1/2 shadow-lg" style={{ left: `${indicatorPos.x}px`, top: `${indicatorPos.y}px`, borderColor: indicatorColor }}></div>
            </div>
            
            <h2 className="text-2xl font-semibold mb-6">Cores Complementares</h2>
            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-6">
                {complementaryPalette.map(color => <ColorBox key={color} hex={color} onCopy={onCopy} />)}
            </div>

            <h2 className="text-2xl font-semibold mt-16 mb-6">Tons Pastéis</h2>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
                {pastelPalette.map(color => <ColorBox key={color} hex={color} onCopy={onCopy} />)}
            </div>
        </div>
    );
};

// --- Componente InspirationsPage ---
const InspirationsPage = ({ onCopy }) => {
    const palettes = {
        Natureza: [
            { name: "Floresta", colors: ["#2d6a4f", "#40916c", "#52b788", "#74c69d", "#95d5b2"] },
            { name: "Pôr do Sol", colors: ["#ffbe0b", "#fb5607", "#ff006e", "#8338ec", "#3a86ff"] },
            { name: "Oceano", colors: ["#0077b6", "#0096c7", "#00b4d8", "#48cae4", "#90e0ef"] },
            { name: "Deserto", colors: ["#eacdc2", "#f2a65a", "#f5d547", "#a98743", "#665434"] },
        ],
        "Tons Pastéis": [
            { name: "Doce Sonho", colors: ["#ffadad", "#ffd6a5", "#fdffb6", "#caffbf", "#9bf6ff"] },
            { name: "Sonho de Verão", colors: ["#a0c4ff", "#bdb2ff", "#ffc6ff", "#fffffc", "#ffffff"] },
            { name: "Lavanda", colors: ["#e0b1cb", "#bda0bc", "#9a8fa6", "#787d91", "#576a7c"] },
            { name: "Menta", colors: ["#c1fba4", "#7bf1a8", "#3ac5a3", "#1d9a99", "#136f84"] },
        ],
        Universo: [
            { name: "Galáxia", colors: ["#03045e", "#023e8a", "#0077b6", "#0096c7", "#00b4d8"] },
            { name: "Nebulosa", colors: ["#4a0072", "#7b1fa2", "#9c27b0", "#ba68c8", "#ce93d8"] },
            { name: "Estrelado", colors: ["#0d1b2a", "#1b263b", "#415a77", "#778da9", "#e0e1dd"] },
            { name: "Buraco Negro", colors: ["#000000", "#141414", "#282828", "#3c3c3c", "#505050"] },
        ],
        Cidade: [
            { name: "Neon Noturno", colors: ["#f72585", "#b5179e", "#7209b7", "#560bad", "#480ca8"] },
            { name: "Urbano", colors: ["#495057", "#6c757d", "#adb5bd", "#dee2e6", "#f8f9fa"] },
            { name: "Metrópole", colors: ["#d90429", "#ef233c", "#8d99ae", "#2b2d42", "#ffffff"] },
            { name: "Grafite", colors: ["#ffc107", "#2196f3", "#f44336", "#4caf50", "#9c27b0"] },
        ],
        Feira: [
            { name: "Frutas", colors: ["#ef476f", "#ffd166", "#06d6a0", "#118ab2", "#073b4c"] },
            { name: "Verduras", colors: ["#55a630", "#80b918", "#aacc00", "#bfd200", "#d4d700"] },
            { name: "Doces", colors: ["#ff8fab", "#fb6f92", "#ff5d8f", "#ff0a54", "#f70649"] },
            { name: "Especiarias", colors: ["#c97b63", "#a44a3f", "#79190e", "#500000", "#280000"] },
        ],
    };

    return (
        <div className="container mx-auto p-8">
            <h1 className="text-4xl font-bold mb-12 text-center">Inspirações de Paletas</h1>
            {Object.entries(palettes).map(([category, paletteList]) => (
                <section key={category} className="mb-16">
                    <h2 className="text-3xl font-semibold mb-6 border-b-2 border-muted-theme/20 pb-2">{category}</h2>
                    <div className="grid md:grid-cols-2 gap-x-12 gap-y-8">
                        {paletteList.map(palette => (
                            <div key={palette.name} className="glass-border p-4 rounded-xl">
                                <h3 className="text-xl font-medium mb-3 text-muted-theme">{palette.name}</h3>
                                <div className="flex space-x-0">
                                    {palette.colors.map(color => (
                                        <div key={color} className="flex-1 h-20 transform hover:scale-105 transition-transform cursor-pointer" style={{ backgroundColor: color }} onClick={() => onCopy(color)} title={`Copiar ${color.toUpperCase()}`}></div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                </section>
            ))}
        </div>
    );
};

// --- Componente ExtractPalettePage ---
const ExtractPalettePage = ({ onCopy }) => {
    const [imageSrc, setImageSrc] = useState(null);
    const [palette, setPalette] = useState([]);
    const [isLoading, setIsLoading] = useState(false);
    const fileInputRef = useRef(null);

    const handleImageUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                setImageSrc(event.target.result);
                extractColors(event.target.result);
            };
            reader.readAsDataURL(file);
        }
    };
    
    const extractColors = async (imageDataUrl) => {
        setIsLoading(true);
        setPalette([]);
        const base64Data = imageDataUrl.split(',')[1];
        const mimeType = imageDataUrl.split(';')[0].split(':')[1];
        
        const prompt = "Extraia as 5 cores dominantes desta imagem. Responda apenas com um array JSON de 5 strings hexadecimais (ex: [\"#ff0000\", ...]).";
        const imagePart = { inlineData: { mimeType, data: base64Data } };
        
        const apiKey = ""; // Será fornecida pelo ambiente
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
        const payload = {
            contents: [{ role: "user", parts: [ {text: prompt}, imagePart ] }],
            generationConfig: { responseMimeType: "application/json" }
        };

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error(`API Error: ${response.status}`);
            const result = await response.json();
            const colors = JSON.parse(result.candidates[0].content.parts[0].text);
            setPalette(colors);
        } catch (error) {
            console.error("Erro ao extrair cores:", error);
            alert("Não foi possível extrair as cores. Tente outra imagem.");
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="container mx-auto p-8 text-center">
            <h1 className="text-4xl font-bold mb-4">Extrair Paleta de Imagem</h1>
            <p className="text-muted-theme mb-8">Suba uma imagem para que a IA identifique as cores principais.</p>
            <input type="file" ref={fileInputRef} onChange={handleImageUpload} accept="image/*" className="hidden" />
            <button onClick={() => fileInputRef.current.click()} className="btn-glass py-3 px-6 rounded-lg text-lg font-semibold">
                Selecionar Imagem
            </button>

            <div className="mt-12">
                {isLoading && <div className="loader mx-auto"></div>}
                {imageSrc && !isLoading && (
                    <div className="grid md:grid-cols-2 gap-8 items-center">
                        <img src={imageSrc} alt="[Imagem enviada]" className="rounded-xl shadow-lg max-h-96 mx-auto" />
                        <div className="flex justify-center flex-wrap gap-4">
                             {palette.map(color => <ColorBox key={color} hex={color} onCopy={onCopy} />)}
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
};


// --- Componente Principal App ---
export default function App() {
    const [page, setPage] = useState('home');
    const [isLightMode, setIsLightMode] = useState(false);
    const [copyMessageVisible, setCopyMessageVisible] = useState(false);

    useEffect(() => {
        const savedTheme = localStorage.getItem('theme');
        const isLight = savedTheme === 'light';
        setIsLightMode(isLight);
        document.body.classList.toggle('light-mode', isLight);
    }, []);

    const handleThemeToggle = () => {
        const newIsLightMode = !isLightMode;
        setIsLightMode(newIsLightMode);
        document.body.classList.toggle('light-mode', newIsLightMode);
        localStorage.setItem('theme', newIsLightMode ? 'light' : 'dark');
    };

    const handleCopyToClipboard = (text) => {
        const textArea = document.createElement("textarea");
        textArea.value = text.toUpperCase();
        
        // Make it invisible
        textArea.style.position = "fixed";
        textArea.style.top = 0;
        textArea.style.left = 0;
        textArea.style.width = "2em";
        textArea.style.height = "2em";
        textArea.style.padding = 0;
        textArea.style.border = "none";
        textArea.style.outline = "none";
        textArea.style.boxShadow = "none";
        textArea.style.background = "transparent";

        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
            document.execCommand('copy');
            setCopyMessageVisible(true);
            setTimeout(() => setCopyMessageVisible(false), 2000);
        } catch (err) {
            console.error('Falha ao copiar: ', err);
        }

        document.body.removeChild(textArea);
    };

    return (
        <div className={`bg-theme text-theme min-h-screen`}>
            <header className="py-4 px-8 flex justify-between items-center glass-border">
                <nav className="flex items-center space-x-6">
                    <button onClick={() => setPage('home')} className={`font-semibold text-lg hover:text-indigo-400 transition-colors ${page === 'home' ? 'text-indigo-400' : ''}`}>Início</button>
                    <button onClick={() => setPage('inspirations')} className={`font-semibold text-lg hover:text-indigo-400 transition-colors ${page === 'inspirations' ? 'text-indigo-400' : ''}`}>Inspirações</button>
                    <button onClick={() => setPage('extract')} className={`font-semibold text-lg hover:text-indigo-400 transition-colors ${page === 'extract' ? 'text-indigo-400' : ''}`}>Extrair Paleta</button>
                </nav>
                <button onClick={handleThemeToggle} className="p-2 rounded-full glass-border">
                    {isLightMode ? (
                        <svg className="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    ) : (
                        <svg className="w-6 h-6 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    )}
                </button>
            </header>

            <main>
                {page === 'home' && <HomePage onCopy={handleCopyToClipboard} />}
                {page === 'inspirations' && <InspirationsPage onCopy={handleCopyToClipboard} />}
                {page === 'extract' && <ExtractPalettePage onCopy={handleCopyToClipboard} />}
            </main>
            
            <div className={`fixed bottom-10 left-1/2 -translate-x-1/2 bg-green-500 text-white py-2 px-5 rounded-lg shadow-lg transition-opacity duration-300 ${copyMessageVisible ? 'opacity-100' : 'opacity-0'}`}>
                Copiado para a área de transferência!
            </div>
        </div>
    );
}
